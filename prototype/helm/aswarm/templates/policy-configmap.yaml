{{- if .Values.global.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aswarm.fullname" . }}-policies
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "aswarm.labels" . | nindent 4 }}
    app.kubernetes.io/component: policies
data:
  policy_catalog.yaml: |
    # A-SWARM Policy Catalog
    # Generated by Helm at {{ now | date "2006-01-02T15:04:05Z07:00" }}
    
    settings:
      max_ring: {{ .Values.global.maxRing }}
      dry_run: {{ .Values.global.dryRun }}
      default_ttl: {{ .Values.microact.enforcement.defaultTTL }}
    
    policies:
    {{- range .Values.policies.defaults }}
      - name: {{ .name }}
        ring: {{ .ring }}
        action: {{ .action }}
        conditions:
          min_score: {{ .scoreThreshold }}
        params:
          ttl_seconds: {{ .ttlSeconds }}
          {{- with .params }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
    {{- end }}
    
    {{- range .Values.policies.custom }}
      - name: {{ .name }}
        ring: {{ .ring }}
        action: {{ .action }}
        {{- with .conditions }}
        conditions:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        {{- with .params }}
        params:
          {{- toYaml . | nindent 10 }}
        {{- end }}
    {{- end }}
{{- end -}}